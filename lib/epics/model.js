import "core-js/modules/es.date.to-string";
import "core-js/modules/es.object.to-string";
import "core-js/modules/es.regexp.to-string";
import _Reflect$construct from "@babel/runtime-corejs3/core-js-stable/reflect/construct";
import _Object$assign from "@babel/runtime-corejs3/core-js-stable/object/assign";
import _concatInstanceProperty from "@babel/runtime-corejs3/core-js-stable/instance/concat";
import _join from "ramda/src/join";
import _prop from "ramda/src/prop";
import _classCallCheck from "@babel/runtime-corejs3/helpers/esm/classCallCheck";
import _createClass from "@babel/runtime-corejs3/helpers/esm/createClass";
import _inherits from "@babel/runtime-corejs3/helpers/esm/inherits";
import _possibleConstructorReturn from "@babel/runtime-corejs3/helpers/esm/possibleConstructorReturn";
import _getPrototypeOf from "@babel/runtime-corejs3/helpers/esm/getPrototypeOf";

function _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = _getPrototypeOf(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = _getPrototypeOf(this).constructor; result = _Reflect$construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return _possibleConstructorReturn(this, result); }; }

function _isNativeReflectConstruct() { if (typeof Reflect === "undefined" || !_Reflect$construct) return false; if (_Reflect$construct.sham) return false; if (typeof Proxy === "function") return true; try { Date.prototype.toString.call(_Reflect$construct(Date, [], function () {})); return true; } catch (e) { return false; } }

import * as Actions from '../actions';
import { FETCH_MODEL_INDEX, FETCH_MODEL_DETAIL, REQUEST_DELETE_MODEL, REQUEST_DELETE_REL_TABLE_MODEL, REQUEST_DELETE_MODEL_FROM_DETAIL_PAGE, CHANGE_PAGE } from '../actionConsts';
import { getFilters, getSort, getPage, getDeleteErrors } from '../utils/helpers';
import { map, mergeMap, switchMap } from 'rxjs/operators';
import { ofType } from 'redux-observable';
import { selectTableView } from '../utils/tableView';
import { concat } from 'rxjs';
import * as Logger from '../utils/Logger';
import { Epic } from './epic';
export var ModelEpic = /*#__PURE__*/function (_Epic) {
  _inherits(ModelEpic, _Epic);

  var _super = _createSuper(ModelEpic);

  function ModelEpic() {
    _classCallCheck(this, ModelEpic);

    return _super.apply(this, arguments);
  }

  _createClass(ModelEpic, [{
    key: FETCH_MODEL_INDEX,
    value: function value(action$, state$) {
      var _this = this;

      return action$.pipe(ofType(FETCH_MODEL_INDEX, CHANGE_PAGE), map(_prop('payload')), map(function (payload) {
        var variables = {
          filter: getFilters({
            schema: _this.schema,
            modelName: payload.modelName,
            tableView: selectTableView(state$.value)
          }),
          sort: getSort({
            schema: _this.schema,
            modelName: payload.modelName,
            tableView: selectTableView(state$.value)
          }),
          page: getPage({
            modelName: payload.modelName,
            tableView: selectTableView(state$.value)
          })
        };
        return {
          modelName: payload.modelName,
          variables: variables
        };
      }), mergeMap(function (context) {
        var query = _this.queryBuilder.buildQuery({
          modelName: context.modelName,
          queryType: 'index'
        });

        return _this.queryBuilder.sendRequest({
          query: query,
          variables: context.variables
        }).then(function (_ref) {
          var data = _ref.data,
              error = _ref.error;
          return {
            context: context,
            data: data,
            error: error
          };
        });
      }), map(function (_ref2) {
        var context = _ref2.context,
            data = _ref2.data,
            error = _ref2.error;

        if (error) {
          return Actions.addDangerAlert({
            message: "Error loading ".concat(context.modelName, " index.")
          });
        }

        return Actions.updateModelIndex({
          modelName: context.modelName,
          data: data
        });
      }));
    }
  }, {
    key: FETCH_MODEL_DETAIL,
    value: function value(action$) {
      var _this2 = this;

      return action$.pipe(ofType(FETCH_MODEL_DETAIL), map(_prop('payload')), map(function (payload) {
        var variables = {
          id: payload.id
        };
        return {
          modelName: payload.modelName,
          id: payload.id,
          variables: variables
        };
      }), mergeMap(function (context) {
        var query = _this2.queryBuilder.buildQuery({
          modelName: context.modelName,
          queryType: 'detail'
        });

        return _this2.queryBuilder.sendRequest({
          query: query,
          variables: context.variables
        }).then(function (_ref3) {
          var data = _ref3.data,
              error = _ref3.error;
          return {
            context: context,
            data: data,
            error: error
          };
        });
      }), switchMap(function (_ref4) {
        var context = _ref4.context,
            data = _ref4.data,
            error = _ref4.error;

        if (error) {
          return concat([Actions.addDangerAlert({
            message: "Error loading ".concat(context.modelName, " details.")
          }), Actions.modelNotFound({
            modelName: context.modelName
          })]);
        }

        return concat([Actions.updateModelDetail({
          modelName: context.modelName,
          id: context.id,
          data: data
        })]);
      }));
    }
  }, {
    key: REQUEST_DELETE_MODEL,
    value: function value(action$) {
      var _this3 = this;

      return action$.pipe(ofType(REQUEST_DELETE_MODEL), map(_prop('payload')), map(function (payload) {
        var query = _this3.queryBuilder.buildQuery({
          modelName: payload.modelName,
          queryType: 'delete'
        });

        var variables = {
          id: payload.id
        };
        return {
          modelName: payload.modelName,
          id: payload.id,
          query: query,
          variables: variables
        };
      }), mergeMap(function (context) {
        return _this3.queryBuilder.sendRequest({
          query: context.query,
          variables: context.variables
        }).then(function (_ref5) {
          var data = _ref5.data,
              error = _ref5.error;
          return {
            context: context,
            data: data,
            error: error
          };
        });
      }), switchMap(function (_ref6) {
        var context = _ref6.context,
            data = _ref6.data,
            error = _ref6.error;

        // todo: pass 'node' and 'data' props
        // @ts-ignore
        var displayName = _this3.schema.getModelLabel({
          modelName: context.modelName
        }); // get errors from context


        var errors = getDeleteErrors({
          data: data,
          context: context
        });

        if (errors) {
          var _context;

          Logger.epicError('requestDeleteModelEpic', context, error);

          var contactErrors = _join('. ', errors);

          return concat([Actions.addDangerAlert({
            message: _concatInstanceProperty(_context = "Error deleting ".concat(displayName, ". ")).call(_context, contactErrors)
          })]);
        } // get errors from 'error' prop


        if (error) {
          Logger.epicError('requestDeleteModelEpic', context, error);
          return concat([Actions.addDangerAlert({
            message: "Error deleting ".concat(displayName, ".")
          })]);
        }

        return concat([Actions.updateDeleteModel({
          modelName: context.modelName,
          id: context.id
        }), Actions.addSuccessAlert({
          message: "".concat(displayName, " was successfully deleted.")
        })]);
      }));
    }
  }, {
    key: REQUEST_DELETE_REL_TABLE_MODEL,
    value: function value(action$) {
      var _this4 = this;

      return action$.pipe(ofType(REQUEST_DELETE_REL_TABLE_MODEL), map(_prop('payload')), map(function (payload) {
        var query = _this4.queryBuilder.buildQuery({
          modelName: payload.modelName,
          queryType: 'delete'
        });

        var variables = {
          id: payload.id
        };
        return _Object$assign({}, payload, {
          query: query,
          variables: variables
        });
      }), mergeMap(function (context) {
        return _this4.queryBuilder.sendRequest({
          query: context.query,
          variables: context.variables
        }).then(function (_ref7) {
          var data = _ref7.data,
              error = _ref7.error;
          return {
            context: context,
            data: data,
            error: error
          };
        });
      }), switchMap(function (_ref8) {
        var context = _ref8.context,
            data = _ref8.data,
            error = _ref8.error;

        // todo: pass node and data props in
        // @ts-ignore
        var displayName = _this4.schema.getModelLabel({
          modelName: context.modelName
        }); // get errors from context


        var errors = getDeleteErrors({
          data: data,
          context: context
        });

        if (errors) {
          var _context2;

          Logger.epicError('requestDeleteModelEpic', context, error);

          var contactErrors = _join('. ', errors);

          return concat([Actions.addDangerAlert({
            message: _concatInstanceProperty(_context2 = "Error deleting ".concat(displayName, ". ")).call(_context2, contactErrors)
          })]);
        }

        if (error) {
          Logger.epicError('requestDeleteRelTableModelEpic', context, error);
          return concat([Actions.addDangerAlert({
            message: "Error deleting ".concat(displayName, ".")
          })]);
        }

        return concat([Actions.fetchModelDetail({
          modelName: context.parentModel,
          id: context.parentId
        }), Actions.addSuccessAlert({
          message: "".concat(displayName, " was successfully deleted.")
        })]);
      }));
    }
  }, {
    key: REQUEST_DELETE_MODEL_FROM_DETAIL_PAGE,
    value: function value(action$) {
      var _this5 = this;

      return action$.pipe(ofType(REQUEST_DELETE_MODEL_FROM_DETAIL_PAGE), map(_prop('payload')), map(function (payload) {
        var query = _this5.queryBuilder.buildQuery({
          modelName: payload.modelName,
          queryType: 'delete'
        });

        var variables = {
          id: payload.id
        };
        return {
          modelName: payload.modelName,
          id: payload.id,
          query: query,
          variables: variables
        };
      }), mergeMap(function (context) {
        return _this5.queryBuilder.sendRequest({
          query: context.query,
          variables: context.variables
        }).then(function (_ref9) {
          var data = _ref9.data,
              error = _ref9.error;
          return {
            context: context,
            data: data,
            error: error
          };
        });
      }), switchMap(function (_ref10) {
        var context = _ref10.context,
            data = _ref10.data,
            error = _ref10.error;

        // todo: pass node and data props in
        // @ts-ignore
        var displayName = _this5.schema.getModelLabel({
          modelName: context.modelName
        }); // get errors from context


        var errors = getDeleteErrors({
          data: data,
          context: context
        });

        if (errors) {
          var _context3;

          Logger.epicError('requestDeleteModelEpic', context, error);

          var contactErrors = _join('. ', errors);

          return concat([Actions.addDangerAlert({
            message: _concatInstanceProperty(_context3 = "Error deleting ".concat(displayName, ". ")).call(_context3, contactErrors)
          })]);
        }

        if (error) {
          Logger.epicError('requestDeleteModelFromDetailPageEpic', context, error);
          return concat([Actions.addDangerAlert({
            message: "Error deleting ".concat(displayName, ".")
          })]);
        }

        return concat([Actions.removeInstance({
          modelName: context.modelName,
          id: context.id
        }), Actions.addSuccessAlert({
          message: "".concat(displayName, " was successfully deleted.")
        })]);
      }));
    }
  }]);

  return ModelEpic;
}(Epic);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9lcGljcy9tb2RlbC50cyJdLCJuYW1lcyI6WyJBY3Rpb25zIiwiRkVUQ0hfTU9ERUxfSU5ERVgiLCJGRVRDSF9NT0RFTF9ERVRBSUwiLCJSRVFVRVNUX0RFTEVURV9NT0RFTCIsIlJFUVVFU1RfREVMRVRFX1JFTF9UQUJMRV9NT0RFTCIsIlJFUVVFU1RfREVMRVRFX01PREVMX0ZST01fREVUQUlMX1BBR0UiLCJDSEFOR0VfUEFHRSIsImdldEZpbHRlcnMiLCJnZXRTb3J0IiwiZ2V0UGFnZSIsImdldERlbGV0ZUVycm9ycyIsIm1hcCIsIm1lcmdlTWFwIiwic3dpdGNoTWFwIiwib2ZUeXBlIiwic2VsZWN0VGFibGVWaWV3IiwiY29uY2F0IiwiTG9nZ2VyIiwiRXBpYyIsIk1vZGVsRXBpYyIsImFjdGlvbiQiLCJzdGF0ZSQiLCJwaXBlIiwicGF5bG9hZCIsInZhcmlhYmxlcyIsImZpbHRlciIsInNjaGVtYSIsIm1vZGVsTmFtZSIsInRhYmxlVmlldyIsInZhbHVlIiwic29ydCIsInBhZ2UiLCJjb250ZXh0IiwicXVlcnkiLCJxdWVyeUJ1aWxkZXIiLCJidWlsZFF1ZXJ5IiwicXVlcnlUeXBlIiwic2VuZFJlcXVlc3QiLCJ0aGVuIiwiZGF0YSIsImVycm9yIiwiYWRkRGFuZ2VyQWxlcnQiLCJtZXNzYWdlIiwidXBkYXRlTW9kZWxJbmRleCIsImlkIiwibW9kZWxOb3RGb3VuZCIsInVwZGF0ZU1vZGVsRGV0YWlsIiwiZGlzcGxheU5hbWUiLCJnZXRNb2RlbExhYmVsIiwiZXJyb3JzIiwiZXBpY0Vycm9yIiwiY29udGFjdEVycm9ycyIsInVwZGF0ZURlbGV0ZU1vZGVsIiwiYWRkU3VjY2Vzc0FsZXJ0IiwiZmV0Y2hNb2RlbERldGFpbCIsInBhcmVudE1vZGVsIiwicGFyZW50SWQiLCJyZW1vdmVJbnN0YW5jZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsT0FBTyxLQUFLQSxPQUFaLE1BQXlCLFlBQXpCO0FBQ0EsU0FDRUMs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Q1poQixPQUFPLENBQUN5QyxjQUFSLENBQXVCO0FBQ3JCQyxZQUFBQSxPQUFPLCtEQUFvQkssV0FBcEIseUJBQW9DSSxhQUFwQztBQURjLFdBQXZCLENBRFksQ0FBRCxDQUFiO0FBS0Q7O0FBRUQsWUFBSVgsS0FBSixFQUFXO0FBQ1R2QixVQUFBQSxNQUFNLENBQUNpQyxTQUFQLENBQ0Usc0NBREYsRUFFRWxCLE9BRkYsRUFHRVEsS0FIRjtBQUtBLGlCQUFPeEIsTUFBTSxDQUFDLENBQ1poQixPQUFPLENBQUN5QyxjQUFSLENBQXVCO0FBQ3JCQyxZQUFBQSxPQUFPLDJCQUFvQkssV0FBcEI7QUFEYyxXQUF2QixDQURZLENBQUQsQ0FBYjtBQUtEOztBQUVELGVBQU8vQixNQUFNLENBQUMsQ0FDWmhCLE9BQU8sQ0FBQ3lELGNBQVIsQ0FBdUI7QUFDckI5QixVQUFBQSxTQUFTLEVBQUVLLE9BQU8sQ0FBQ0wsU0FERTtBQUVyQmlCLFVBQUFBLEVBQUUsRUFBRVosT0FBTyxDQUFDWTtBQUZTLFNBQXZCLENBRFksRUFLWjVDLE9BQU8sQ0FBQ3FELGVBQVIsQ0FBd0I7QUFDdEJYLFVBQUFBLE9BQU8sWUFBS0ssV0FBTDtBQURlLFNBQXhCLENBTFksQ0FBRCxDQUFiO0FBU0QsT0F6Q1EsQ0F4QkosQ0FBUDtBQW1FRDtBQTVSSDs7QUFBQTtBQUFBLEVBQStCN0IsSUFBL0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBBY3Rpb25zIGZyb20gJy4uL2FjdGlvbnMnXG5pbXBvcnQge1xuICBGRVRDSF9NT0RFTF9JTkRFWCxcbiAgRkVUQ0hfTU9ERUxfREVUQUlMLFxuICBSRVFVRVNUX0RFTEVURV9NT0RFTCxcbiAgUkVRVUVTVF9ERUxFVEVfUkVMX1RBQkxFX01PREVMLFxuICBSRVFVRVNUX0RFTEVURV9NT0RFTF9GUk9NX0RFVEFJTF9QQUdFLFxuICBDSEFOR0VfUEFHRVxufSBmcm9tICcuLi9hY3Rpb25Db25zdHMnXG5pbXBvcnQgKiBhcyBSIGZyb20gJ3JhbWRhJ1xuaW1wb3J0IHsgZ2V0RmlsdGVycywgZ2V0U29ydCwgZ2V0UGFnZSwgZ2V0RGVsZXRlRXJyb3JzIH0gZnJvbSAnLi4vdXRpbHMvaGVscGVycydcbmltcG9ydCB7IG1hcCwgbWVyZ2VNYXAsIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJ1xuaW1wb3J0IHsgb2ZUeXBlIH0gZnJvbSAncmVkdXgtb2JzZXJ2YWJsZSdcbmltcG9ydCB7IHNlbGVjdFRhYmxlVmlldyB9IGZyb20gJy4uL3V0aWxzL3RhYmxlVmlldydcbmltcG9ydCB7IGNvbmNhdCB9IGZyb20gJ3J4anMnXG5pbXBvcnQgKiBhcyBMb2dnZXIgZnJvbSAnLi4vdXRpbHMvTG9nZ2VyJ1xuaW1wb3J0IHsgRXBpYyB9IGZyb20gJy4vZXBpYydcblxuZXhwb3J0IGNsYXNzIE1vZGVsRXBpYyBleHRlbmRzIEVwaWMge1xuICBbRkVUQ0hfTU9ERUxfSU5ERVhdKGFjdGlvbiQ6IGFueSwgc3RhdGUkOiBhbnkpIHtcbiAgICByZXR1cm4gYWN0aW9uJC5waXBlKFxuICAgICAgb2ZUeXBlKEZFVENIX01PREVMX0lOREVYLCBDSEFOR0VfUEFHRSksXG4gICAgICBtYXAoUi5wcm9wKCdwYXlsb2FkJykpLFxuICAgICAgbWFwKChwYXlsb2FkOiBFcGljUGF5bG9hZCkgPT4ge1xuICAgICAgICBjb25zdCB2YXJpYWJsZXMgPSB7XG4gICAgICAgICAgZmlsdGVyOiBnZXRGaWx0ZXJzKHtcbiAgICAgICAgICAgIHNjaGVtYTogdGhpcy5zY2hlbWEsXG4gICAgICAgICAgICBtb2RlbE5hbWU6IHBheWxvYWQubW9kZWxOYW1lIGFzIHN0cmluZyxcbiAgICAgICAgICAgIHRhYmxlVmlldzogc2VsZWN0VGFibGVWaWV3KHN0YXRlJC52YWx1ZSlcbiAgICAgICAgICB9KSxcbiAgICAgICAgICBzb3J0OiBnZXRTb3J0KHtcbiAgICAgICAgICAgIHNjaGVtYTogdGhpcy5zY2hlbWEsXG4gICAgICAgICAgICBtb2RlbE5hbWU6IHBheWxvYWQubW9kZWxOYW1lIGFzIHN0cmluZyxcbiAgICAgICAgICAgIHRhYmxlVmlldzogc2VsZWN0VGFibGVWaWV3KHN0YXRlJC52YWx1ZSlcbiAgICAgICAgICB9KSxcbiAgICAgICAgICBwYWdlOiBnZXRQYWdlKHtcbiAgICAgICAgICAgIG1vZGVsTmFtZTogcGF5bG9hZC5tb2RlbE5hbWUgYXMgc3RyaW5nLFxuICAgICAgICAgICAgdGFibGVWaWV3OiBzZWxlY3RUYWJsZVZpZXcoc3RhdGUkLnZhbHVlKVxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHsgbW9kZWxOYW1lOiBwYXlsb2FkLm1vZGVsTmFtZSwgdmFyaWFibGVzIH1cbiAgICAgIH0pLFxuICAgICAgbWVyZ2VNYXAoKGNvbnRleHQ6IGFueSkgPT4ge1xuICAgICAgICBjb25zdCBxdWVyeSA9IHRoaXMucXVlcnlCdWlsZGVyLmJ1aWxkUXVlcnkoe1xuICAgICAgICAgIG1vZGVsTmFtZTogY29udGV4dC5tb2RlbE5hbWUsXG4gICAgICAgICAgcXVlcnlUeXBlOiAnaW5kZXgnXG4gICAgICAgIH0pXG4gICAgICAgIHJldHVybiB0aGlzLnF1ZXJ5QnVpbGRlclxuICAgICAgICAgIC5zZW5kUmVxdWVzdCh7IHF1ZXJ5LCB2YXJpYWJsZXM6IGNvbnRleHQudmFyaWFibGVzIH0pXG4gICAgICAgICAgLnRoZW4oKHsgZGF0YSwgZXJyb3IgfSkgPT4gKHsgY29udGV4dCwgZGF0YSwgZXJyb3IgfSkpXG4gICAgICB9KSxcbiAgICAgIG1hcChcbiAgICAgICAgKHsgY29udGV4dCwgZGF0YSwgZXJyb3IgfTogeyBjb250ZXh0OiBhbnk7IGRhdGE6IGFueTsgZXJyb3I6IGFueSB9KSA9PiB7XG4gICAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgICByZXR1cm4gQWN0aW9ucy5hZGREYW5nZXJBbGVydCh7XG4gICAgICAgICAgICAgIG1lc3NhZ2U6IGBFcnJvciBsb2FkaW5nICR7Y29udGV4dC5tb2RlbE5hbWV9IGluZGV4LmBcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBBY3Rpb25zLnVwZGF0ZU1vZGVsSW5kZXgoe1xuICAgICAgICAgICAgbW9kZWxOYW1lOiBjb250ZXh0Lm1vZGVsTmFtZSxcbiAgICAgICAgICAgIGRhdGFcbiAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICApXG4gICAgKVxuICB9XG5cbiAgW0ZFVENIX01PREVMX0RFVEFJTF0oYWN0aW9uJDogYW55KSB7XG4gICAgcmV0dXJuIGFjdGlvbiQucGlwZShcbiAgICAgIG9mVHlwZShGRVRDSF9NT0RFTF9ERVRBSUwpLFxuICAgICAgbWFwKFIucHJvcCgncGF5bG9hZCcpKSxcbiAgICAgIG1hcCgocGF5bG9hZDogRXBpY1BheWxvYWQpID0+IHtcbiAgICAgICAgY29uc3QgdmFyaWFibGVzID0geyBpZDogcGF5bG9hZC5pZCB9XG4gICAgICAgIHJldHVybiB7IG1vZGVsTmFtZTogcGF5bG9hZC5tb2RlbE5hbWUsIGlkOiBwYXlsb2FkLmlkLCB2YXJpYWJsZXMgfVxuICAgICAgfSksXG4gICAgICBtZXJnZU1hcCgoY29udGV4dDogYW55KSA9PiB7XG4gICAgICAgIGNvbnN0IHF1ZXJ5ID0gdGhpcy5xdWVyeUJ1aWxkZXIuYnVpbGRRdWVyeSh7XG4gICAgICAgICAgbW9kZWxOYW1lOiBjb250ZXh0Lm1vZGVsTmFtZSxcbiAgICAgICAgICBxdWVyeVR5cGU6ICdkZXRhaWwnXG4gICAgICAgIH0pXG4gICAgICAgIHJldHVybiB0aGlzLnF1ZXJ5QnVpbGRlclxuICAgICAgICAgIC5zZW5kUmVxdWVzdCh7IHF1ZXJ5LCB2YXJpYWJsZXM6IGNvbnRleHQudmFyaWFibGVzIH0pXG4gICAgICAgICAgLnRoZW4oKHsgZGF0YSwgZXJyb3IgfSkgPT4gKHsgY29udGV4dCwgZGF0YSwgZXJyb3IgfSkpXG4gICAgICB9KSxcbiAgICAgIHN3aXRjaE1hcCgoeyBjb250ZXh0LCBkYXRhLCBlcnJvciB9KTogYW55ID0+IHtcbiAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgcmV0dXJuIGNvbmNhdChbXG4gICAgICAgICAgICBBY3Rpb25zLmFkZERhbmdlckFsZXJ0KHtcbiAgICAgICAgICAgICAgbWVzc2FnZTogYEVycm9yIGxvYWRpbmcgJHtjb250ZXh0Lm1vZGVsTmFtZX0gZGV0YWlscy5gXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIEFjdGlvbnMubW9kZWxOb3RGb3VuZCh7XG4gICAgICAgICAgICAgIG1vZGVsTmFtZTogY29udGV4dC5tb2RlbE5hbWVcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgXSlcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY29uY2F0KFtcbiAgICAgICAgICBBY3Rpb25zLnVwZGF0ZU1vZGVsRGV0YWlsKHtcbiAgICAgICAgICAgIG1vZGVsTmFtZTogY29udGV4dC5tb2RlbE5hbWUsXG4gICAgICAgICAgICBpZDogY29udGV4dC5pZCxcbiAgICAgICAgICAgIGRhdGFcbiAgICAgICAgICB9KVxuICAgICAgICBdKVxuICAgICAgfSlcbiAgICApXG4gIH1cblxuICBbUkVRVUVTVF9ERUxFVEVfTU9ERUxdKGFjdGlvbiQ6IGFueSkge1xuICAgIHJldHVybiBhY3Rpb24kLnBpcGUoXG4gICAgICBvZlR5cGUoUkVRVUVTVF9ERUxFVEVfTU9ERUwpLFxuICAgICAgbWFwKFIucHJvcCgncGF5bG9hZCcpKSxcbiAgICAgIG1hcCgocGF5bG9hZDogRXBpY1BheWxvYWQpID0+IHtcbiAgICAgICAgY29uc3QgcXVlcnkgPSB0aGlzLnF1ZXJ5QnVpbGRlci5idWlsZFF1ZXJ5KHtcbiAgICAgICAgICBtb2RlbE5hbWU6IHBheWxvYWQubW9kZWxOYW1lLFxuICAgICAgICAgIHF1ZXJ5VHlwZTogJ2RlbGV0ZSdcbiAgICAgICAgfSlcbiAgICAgICAgY29uc3QgdmFyaWFibGVzID0geyBpZDogcGF5bG9hZC5pZCB9XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgbW9kZWxOYW1lOiBwYXlsb2FkLm1vZGVsTmFtZSxcbiAgICAgICAgICBpZDogcGF5bG9hZC5pZCxcbiAgICAgICAgICBxdWVyeSxcbiAgICAgICAgICB2YXJpYWJsZXNcbiAgICAgICAgfVxuICAgICAgfSksXG4gICAgICBtZXJnZU1hcCgoY29udGV4dDogYW55KSA9PlxuICAgICAgICB0aGlzLnF1ZXJ5QnVpbGRlclxuICAgICAgICAgIC5zZW5kUmVxdWVzdCh7XG4gICAgICAgICAgICBxdWVyeTogY29udGV4dC5xdWVyeSxcbiAgICAgICAgICAgIHZhcmlhYmxlczogY29udGV4dC52YXJpYWJsZXNcbiAgICAgICAgICB9KVxuICAgICAgICAgIC50aGVuKCh7IGRhdGEsIGVycm9yIH0pID0+ICh7IGNvbnRleHQsIGRhdGEsIGVycm9yIH0pKVxuICAgICAgKSxcbiAgICAgIHN3aXRjaE1hcCgoeyBjb250ZXh0LCBkYXRhLCBlcnJvciB9KSA9PiB7XG4gICAgICAgIC8vIHRvZG86IHBhc3MgJ25vZGUnIGFuZCAnZGF0YScgcHJvcHNcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICBjb25zdCBkaXNwbGF5TmFtZSA9IHRoaXMuc2NoZW1hLmdldE1vZGVsTGFiZWwoe1xuICAgICAgICAgIG1vZGVsTmFtZTogY29udGV4dC5tb2RlbE5hbWVcbiAgICAgICAgfSlcblxuICAgICAgICAvLyBnZXQgZXJyb3JzIGZyb20gY29udGV4dFxuICAgICAgICBjb25zdCBlcnJvcnMgPSBnZXREZWxldGVFcnJvcnMoeyBkYXRhLCBjb250ZXh0IH0pXG4gICAgICAgIGlmIChlcnJvcnMpIHtcbiAgICAgICAgICBMb2dnZXIuZXBpY0Vycm9yKCdyZXF1ZXN0RGVsZXRlTW9kZWxFcGljJywgY29udGV4dCwgZXJyb3IpXG4gICAgICAgICAgY29uc3QgY29udGFjdEVycm9ycyA9IFIuam9pbignLiAnLCBlcnJvcnMpXG4gICAgICAgICAgcmV0dXJuIGNvbmNhdChbXG4gICAgICAgICAgICBBY3Rpb25zLmFkZERhbmdlckFsZXJ0KHtcbiAgICAgICAgICAgICAgbWVzc2FnZTogYEVycm9yIGRlbGV0aW5nICR7ZGlzcGxheU5hbWV9LiAke2NvbnRhY3RFcnJvcnN9YFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICBdKVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gZ2V0IGVycm9ycyBmcm9tICdlcnJvcicgcHJvcFxuICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICBMb2dnZXIuZXBpY0Vycm9yKCdyZXF1ZXN0RGVsZXRlTW9kZWxFcGljJywgY29udGV4dCwgZXJyb3IpXG4gICAgICAgICAgcmV0dXJuIGNvbmNhdChbXG4gICAgICAgICAgICBBY3Rpb25zLmFkZERhbmdlckFsZXJ0KHtcbiAgICAgICAgICAgICAgbWVzc2FnZTogYEVycm9yIGRlbGV0aW5nICR7ZGlzcGxheU5hbWV9LmBcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgXSlcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBjb25jYXQoW1xuICAgICAgICAgIEFjdGlvbnMudXBkYXRlRGVsZXRlTW9kZWwoe1xuICAgICAgICAgICAgbW9kZWxOYW1lOiBjb250ZXh0Lm1vZGVsTmFtZSxcbiAgICAgICAgICAgIGlkOiBjb250ZXh0LmlkXG4gICAgICAgICAgfSksXG4gICAgICAgICAgQWN0aW9ucy5hZGRTdWNjZXNzQWxlcnQoe1xuICAgICAgICAgICAgbWVzc2FnZTogYCR7ZGlzcGxheU5hbWV9IHdhcyBzdWNjZXNzZnVsbHkgZGVsZXRlZC5gXG4gICAgICAgICAgfSlcbiAgICAgICAgXSlcbiAgICAgIH0pXG4gICAgKVxuICB9XG5cbiAgW1JFUVVFU1RfREVMRVRFX1JFTF9UQUJMRV9NT0RFTF0oYWN0aW9uJDogYW55KSB7XG4gICAgcmV0dXJuIGFjdGlvbiQucGlwZShcbiAgICAgIG9mVHlwZShSRVFVRVNUX0RFTEVURV9SRUxfVEFCTEVfTU9ERUwpLFxuICAgICAgbWFwKFIucHJvcCgncGF5bG9hZCcpKSxcbiAgICAgIG1hcCgocGF5bG9hZDogRXBpY1BheWxvYWQpID0+IHtcbiAgICAgICAgY29uc3QgcXVlcnkgPSB0aGlzLnF1ZXJ5QnVpbGRlci5idWlsZFF1ZXJ5KHtcbiAgICAgICAgICBtb2RlbE5hbWU6IHBheWxvYWQubW9kZWxOYW1lLFxuICAgICAgICAgIHF1ZXJ5VHlwZTogJ2RlbGV0ZSdcbiAgICAgICAgfSlcbiAgICAgICAgY29uc3QgdmFyaWFibGVzID0geyBpZDogcGF5bG9hZC5pZCB9XG4gICAgICAgIHJldHVybiB7IC4uLnBheWxvYWQsIHF1ZXJ5LCB2YXJpYWJsZXMgfVxuICAgICAgfSksXG4gICAgICBtZXJnZU1hcCgoY29udGV4dDogYW55KSA9PlxuICAgICAgICB0aGlzLnF1ZXJ5QnVpbGRlclxuICAgICAgICAgIC5zZW5kUmVxdWVzdCh7XG4gICAgICAgICAgICBxdWVyeTogY29udGV4dC5xdWVyeSxcbiAgICAgICAgICAgIHZhcmlhYmxlczogY29udGV4dC52YXJpYWJsZXNcbiAgICAgICAgICB9KVxuICAgICAgICAgIC50aGVuKCh7IGRhdGEsIGVycm9yIH0pID0+ICh7IGNvbnRleHQsIGRhdGEsIGVycm9yIH0pKVxuICAgICAgKSxcbiAgICAgIHN3aXRjaE1hcCgoeyBjb250ZXh0LCBkYXRhLCBlcnJvciB9KSA9PiB7XG4gICAgICAgIC8vIHRvZG86IHBhc3Mgbm9kZSBhbmQgZGF0YSBwcm9wcyBpblxuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGNvbnN0IGRpc3BsYXlOYW1lID0gdGhpcy5zY2hlbWEuZ2V0TW9kZWxMYWJlbCh7XG4gICAgICAgICAgbW9kZWxOYW1lOiBjb250ZXh0Lm1vZGVsTmFtZVxuICAgICAgICB9KVxuXG4gICAgICAgIC8vIGdldCBlcnJvcnMgZnJvbSBjb250ZXh0XG4gICAgICAgIGNvbnN0IGVycm9ycyA9IGdldERlbGV0ZUVycm9ycyh7IGRhdGEsIGNvbnRleHQgfSlcbiAgICAgICAgaWYgKGVycm9ycykge1xuICAgICAgICAgIExvZ2dlci5lcGljRXJyb3IoJ3JlcXVlc3REZWxldGVNb2RlbEVwaWMnLCBjb250ZXh0LCBlcnJvcilcbiAgICAgICAgICBjb25zdCBjb250YWN0RXJyb3JzID0gUi5qb2luKCcuICcsIGVycm9ycylcbiAgICAgICAgICByZXR1cm4gY29uY2F0KFtcbiAgICAgICAgICAgIEFjdGlvbnMuYWRkRGFuZ2VyQWxlcnQoe1xuICAgICAgICAgICAgICBtZXNzYWdlOiBgRXJyb3IgZGVsZXRpbmcgJHtkaXNwbGF5TmFtZX0uICR7Y29udGFjdEVycm9yc31gXG4gICAgICAgICAgICB9KVxuICAgICAgICAgIF0pXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICBMb2dnZXIuZXBpY0Vycm9yKCdyZXF1ZXN0RGVsZXRlUmVsVGFibGVNb2RlbEVwaWMnLCBjb250ZXh0LCBlcnJvcilcbiAgICAgICAgICByZXR1cm4gY29uY2F0KFtcbiAgICAgICAgICAgIEFjdGlvbnMuYWRkRGFuZ2VyQWxlcnQoe1xuICAgICAgICAgICAgICBtZXNzYWdlOiBgRXJyb3IgZGVsZXRpbmcgJHtkaXNwbGF5TmFtZX0uYFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICBdKVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGNvbmNhdChbXG4gICAgICAgICAgQWN0aW9ucy5mZXRjaE1vZGVsRGV0YWlsKHtcbiAgICAgICAgICAgIG1vZGVsTmFtZTogY29udGV4dC5wYXJlbnRNb2RlbCxcbiAgICAgICAgICAgIGlkOiBjb250ZXh0LnBhcmVudElkXG4gICAgICAgICAgfSksXG4gICAgICAgICAgQWN0aW9ucy5hZGRTdWNjZXNzQWxlcnQoe1xuICAgICAgICAgICAgbWVzc2FnZTogYCR7ZGlzcGxheU5hbWV9IHdhcyBzdWNjZXNzZnVsbHkgZGVsZXRlZC5gXG4gICAgICAgICAgfSlcbiAgICAgICAgXSlcbiAgICAgIH0pXG4gICAgKVxuICB9XG5cbiAgW1JFUVVFU1RfREVMRVRFX01PREVMX0ZST01fREVUQUlMX1BBR0VdKGFjdGlvbiQ6IGFueSkge1xuICAgIHJldHVybiBhY3Rpb24kLnBpcGUoXG4gICAgICBvZlR5cGUoUkVRVUVTVF9ERUxFVEVfTU9ERUxfRlJPTV9ERVRBSUxfUEFHRSksXG4gICAgICBtYXAoUi5wcm9wKCdwYXlsb2FkJykpLFxuICAgICAgbWFwKChwYXlsb2FkOiBFcGljUGF5bG9hZCkgPT4ge1xuICAgICAgICBjb25zdCBxdWVyeSA9IHRoaXMucXVlcnlCdWlsZGVyLmJ1aWxkUXVlcnkoe1xuICAgICAgICAgIG1vZGVsTmFtZTogcGF5bG9hZC5tb2RlbE5hbWUsXG4gICAgICAgICAgcXVlcnlUeXBlOiAnZGVsZXRlJ1xuICAgICAgICB9KVxuICAgICAgICBjb25zdCB2YXJpYWJsZXMgPSB7IGlkOiBwYXlsb2FkLmlkIH1cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBtb2RlbE5hbWU6IHBheWxvYWQubW9kZWxOYW1lLFxuICAgICAgICAgIGlkOiBwYXlsb2FkLmlkLFxuICAgICAgICAgIHF1ZXJ5LFxuICAgICAgICAgIHZhcmlhYmxlc1xuICAgICAgICB9XG4gICAgICB9KSxcbiAgICAgIG1lcmdlTWFwKChjb250ZXh0OiBhbnkpID0+XG4gICAgICAgIHRoaXMucXVlcnlCdWlsZGVyXG4gICAgICAgICAgLnNlbmRSZXF1ZXN0KHtcbiAgICAgICAgICAgIHF1ZXJ5OiBjb250ZXh0LnF1ZXJ5LFxuICAgICAgICAgICAgdmFyaWFibGVzOiBjb250ZXh0LnZhcmlhYmxlc1xuICAgICAgICAgIH0pXG4gICAgICAgICAgLnRoZW4oKHsgZGF0YSwgZXJyb3IgfSkgPT4gKHsgY29udGV4dCwgZGF0YSwgZXJyb3IgfSkpXG4gICAgICApLFxuICAgICAgc3dpdGNoTWFwKCh7IGNvbnRleHQsIGRhdGEsIGVycm9yIH0pID0+IHtcbiAgICAgICAgLy8gdG9kbzogcGFzcyBub2RlIGFuZCBkYXRhIHByb3BzIGluXG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgY29uc3QgZGlzcGxheU5hbWUgPSB0aGlzLnNjaGVtYS5nZXRNb2RlbExhYmVsKHtcbiAgICAgICAgICBtb2RlbE5hbWU6IGNvbnRleHQubW9kZWxOYW1lXG4gICAgICAgIH0pXG5cbiAgICAgICAgLy8gZ2V0IGVycm9ycyBmcm9tIGNvbnRleHRcbiAgICAgICAgY29uc3QgZXJyb3JzID0gZ2V0RGVsZXRlRXJyb3JzKHsgZGF0YSwgY29udGV4dCB9KVxuICAgICAgICBpZiAoZXJyb3JzKSB7XG4gICAgICAgICAgTG9nZ2VyLmVwaWNFcnJvcigncmVxdWVzdERlbGV0ZU1vZGVsRXBpYycsIGNvbnRleHQsIGVycm9yKVxuICAgICAgICAgIGNvbnN0IGNvbnRhY3RFcnJvcnMgPSBSLmpvaW4oJy4gJywgZXJyb3JzKVxuICAgICAgICAgIHJldHVybiBjb25jYXQoW1xuICAgICAgICAgICAgQWN0aW9ucy5hZGREYW5nZXJBbGVydCh7XG4gICAgICAgICAgICAgIG1lc3NhZ2U6IGBFcnJvciBkZWxldGluZyAke2Rpc3BsYXlOYW1lfS4gJHtjb250YWN0RXJyb3JzfWBcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgXSlcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgIExvZ2dlci5lcGljRXJyb3IoXG4gICAgICAgICAgICAncmVxdWVzdERlbGV0ZU1vZGVsRnJvbURldGFpbFBhZ2VFcGljJyxcbiAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICAgICBlcnJvclxuICAgICAgICAgIClcbiAgICAgICAgICByZXR1cm4gY29uY2F0KFtcbiAgICAgICAgICAgIEFjdGlvbnMuYWRkRGFuZ2VyQWxlcnQoe1xuICAgICAgICAgICAgICBtZXNzYWdlOiBgRXJyb3IgZGVsZXRpbmcgJHtkaXNwbGF5TmFtZX0uYFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICBdKVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGNvbmNhdChbXG4gICAgICAgICAgQWN0aW9ucy5yZW1vdmVJbnN0YW5jZSh7XG4gICAgICAgICAgICBtb2RlbE5hbWU6IGNvbnRleHQubW9kZWxOYW1lLFxuICAgICAgICAgICAgaWQ6IGNvbnRleHQuaWRcbiAgICAgICAgICB9KSxcbiAgICAgICAgICBBY3Rpb25zLmFkZFN1Y2Nlc3NBbGVydCh7XG4gICAgICAgICAgICBtZXNzYWdlOiBgJHtkaXNwbGF5TmFtZX0gd2FzIHN1Y2Nlc3NmdWxseSBkZWxldGVkLmBcbiAgICAgICAgICB9KVxuICAgICAgICBdKVxuICAgICAgfSlcbiAgICApXG4gIH1cbn1cbiJdfQ==